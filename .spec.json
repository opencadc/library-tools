{
  "$defs": {
    "Build": {
      "additionalProperties": false,
      "description": "Configuration for building the container image.",
      "properties": {
        "context": {
          "default": ".",
          "description": "Path to the build context directory.",
          "examples": [
            ".",
            "images/python"
          ],
          "title": "Build Context",
          "type": "string"
        },
        "file": {
          "default": "Dockerfile",
          "description": "Name of the Dockerfile in the build context.",
          "examples": [
            "Dockerfile",
            "Dockerfile.runtime"
          ],
          "title": "Dockerfile",
          "type": "string"
        },
        "platforms": {
          "default": [
            "linux/amd64"
          ],
          "description": "Target platforms for the build.",
          "examples": [
            [
              "linux/amd64"
            ],
            [
              "linux/amd64",
              "linux/arm64"
            ]
          ],
          "items": {
            "type": "string"
          },
          "title": "Platforms",
          "type": "array"
        },
        "tags": {
          "description": "Image tags to apply.",
          "examples": [
            [
              "latest"
            ],
            [
              "1.0.0",
              "latest"
            ]
          ],
          "items": {
            "type": "string"
          },
          "minItems": 1,
          "title": "Tags",
          "type": "array"
        },
        "output": {
          "default": "type=docker",
          "description": "Output destination (type=docker by default).",
          "examples": [
            "type=docker",
            "type=registry",
            "type=local,dest=./out"
          ],
          "title": "Output",
          "type": "string"
        },
        "options": {
          "default": "",
          "description": "Additional buildx options appended to the build command.",
          "examples": [
            "--target=runtime --push"
          ],
          "title": "Options",
          "type": "string"
        }
      },
      "required": [
        "tags"
      ],
      "title": "Build",
      "type": "object"
    },
    "Config": {
      "additionalProperties": false,
      "description": "Configuration for Library Tools execution.",
      "properties": {
        "policy": {
          "$ref": "#/$defs/Policy",
          "description": "Policy profile and controls."
        },
        "tools": {
          "$ref": "#/$defs/Tools",
          "description": "Tool configuration for Library Tools commands."
        }
      },
      "title": "Config",
      "type": "object"
    },
    "Discovery": {
      "additionalProperties": false,
      "description": "Canonical discovery metadata mapped to OCI labels/annotations.",
      "properties": {
        "title": {
          "description": "Human-readable title of the image.",
          "title": "Title",
          "type": "string"
        },
        "description": {
          "description": "Human-readable description of the software packaged in the image.",
          "title": "Description",
          "type": "string"
        },
        "source": {
          "description": "URL to get source code for building the image",
          "format": "uri",
          "minLength": 1,
          "title": "Source",
          "type": "string"
        },
        "url": {
          "description": "URL to find more information on the image.",
          "format": "uri",
          "minLength": 1,
          "title": "Url",
          "type": "string"
        },
        "documentation": {
          "description": "URL to get documentation on the image",
          "format": "uri",
          "minLength": 1,
          "title": "Documentation",
          "type": "string"
        },
        "version": {
          "description": "Version of the packaged software.",
          "title": "Version",
          "type": "string"
        },
        "revision": {
          "description": "Source control revision identifier for the packaged software. For example a git commit SHA.",
          "title": "Revision",
          "type": "string"
        },
        "created": {
          "description": "Datetime on which the image was built. Conforming to RFC 3339",
          "format": "date-time",
          "title": "Created",
          "type": "string"
        },
        "authors": {
          "description": "Details of the people or organization responsible for the image",
          "title": "Authors",
          "type": "string"
        },
        "licenses": {
          "description": "License(s) under which contained software is distributed as an SPDX License Expression.",
          "title": "Licenses",
          "type": "string"
        }
      },
      "required": [
        "title",
        "description",
        "source",
        "url",
        "documentation",
        "version",
        "revision",
        "created",
        "authors",
        "licenses"
      ],
      "title": "Discovery",
      "type": "object"
    },
    "Git": {
      "additionalProperties": false,
      "description": "Repository information for the image build source.",
      "properties": {
        "repo": {
          "description": "Git repository.",
          "examples": [
            "https://github.com/opencadc/canfar-library"
          ],
          "format": "uri",
          "minLength": 1,
          "title": "Repository",
          "type": "string"
        },
        "fetch": {
          "default": "refs/heads/main",
          "description": "Git fetch reference.",
          "examples": [
            "refs/heads/main",
            "refs/heads/develop"
          ],
          "title": "Git Fetch Reference",
          "type": "string"
        },
        "commit": {
          "description": "SHA commit hash to build.",
          "examples": [
            "1234567890123456789012345678901234567890"
          ],
          "title": "SHA Commit Hash",
          "type": "string"
        }
      },
      "required": [
        "repo",
        "commit"
      ],
      "title": "Git",
      "type": "object"
    },
    "Maintainer": {
      "additionalProperties": false,
      "description": "Details about the maintainer of the image.",
      "properties": {
        "name": {
          "description": "Name of the maintainer.",
          "title": "Name",
          "type": "string"
        },
        "email": {
          "description": "Contact email.",
          "title": "Email",
          "type": "string"
        },
        "github": {
          "anyOf": [
            {
              "type": "string"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "GitHub Username.",
          "title": "GitHub Username"
        },
        "gitlab": {
          "anyOf": [
            {
              "type": "string"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "GitLab Username.",
          "title": "GitLab Username"
        }
      },
      "required": [
        "name",
        "email"
      ],
      "title": "Maintainer",
      "type": "object"
    },
    "Metadata": {
      "additionalProperties": false,
      "description": "Metadata for the image.",
      "properties": {
        "categories": {
          "anyOf": [
            {
              "items": {
                "type": "string"
              },
              "type": "array"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "Categories for the image.",
          "examples": [
            "development",
            "science",
            "astronomy"
          ],
          "title": "Categories"
        },
        "tools": {
          "anyOf": [
            {
              "items": {
                "type": "string"
              },
              "type": "array"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "Tools provided by the image.",
          "examples": [
            "python",
            "jupyter",
            "notebook"
          ],
          "title": "Tools"
        },
        "discovery": {
          "$ref": "#/$defs/Discovery",
          "description": "Canonical discovery metadata."
        }
      },
      "required": [
        "discovery"
      ],
      "title": "Metadata",
      "type": "object"
    },
    "Policy": {
      "additionalProperties": false,
      "description": "Policy profile and enforcement configuration.",
      "properties": {
        "profile": {
          "default": "baseline",
          "description": "Policy profile for tooling behavior.",
          "enum": [
            "baseline",
            "strict",
            "expert"
          ],
          "title": "Profile",
          "type": "string"
        },
        "conflicts": {
          "default": "warn",
          "description": "How to handle discovered conflicts.",
          "enum": [
            "warn",
            "strict"
          ],
          "title": "Conflicts",
          "type": "string"
        }
      },
      "title": "Policy",
      "type": "object"
    },
    "Registry": {
      "additionalProperties": false,
      "description": "Details about the container registry.",
      "properties": {
        "host": {
          "default": "images.canfar.net",
          "description": "Container registry hostname.",
          "examples": [
            "images.canfar.net"
          ],
          "title": "Hostname",
          "type": "string"
        },
        "project": {
          "default": "library",
          "description": "Container registry namespace.",
          "enum": [
            "library",
            "srcnet",
            "skaha"
          ],
          "examples": [
            "skaha"
          ],
          "title": "Project",
          "type": "string"
        },
        "image": {
          "description": "Container image name.",
          "examples": [
            "python",
            "base"
          ],
          "title": "Image Name",
          "type": "string"
        }
      },
      "required": [
        "image"
      ],
      "title": "Registry",
      "type": "object"
    },
    "Runner": {
      "additionalProperties": false,
      "description": "Docker runner configuration (P0).",
      "properties": {
        "kind": {
          "const": "docker",
          "default": "docker",
          "description": "Runner type.",
          "title": "Kind",
          "type": "string"
        },
        "image": {
          "description": "Container image to run.",
          "title": "Image",
          "type": "string"
        },
        "command": {
          "description": "Command to execute in the container.",
          "items": {
            "type": "string"
          },
          "title": "Command",
          "type": "array"
        },
        "env": {
          "anyOf": [
            {
              "additionalProperties": {
                "type": "string"
              },
              "type": "object"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "Environment variables for the container.",
          "title": "Env"
        }
      },
      "required": [
        "image",
        "command"
      ],
      "title": "Runner",
      "type": "object"
    },
    "Tool": {
      "additionalProperties": false,
      "description": "Configuration for tooling.",
      "properties": {
        "parser": {
          "description": "Parser to use for the tool output.",
          "enum": [
            "hadolint",
            "trivy",
            "renovate",
            "curate",
            "provenance",
            "push"
          ],
          "title": "Parser",
          "type": "string"
        },
        "config": {
          "anyOf": [
            {
              "type": "string"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "Path to the tool configuration file.",
          "title": "Config"
        },
        "runner": {
          "anyOf": [
            {
              "$ref": "#/$defs/Runner"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "Runner configuration for tool execution."
        },
        "output": {
          "description": "Path to write the tool output artifact.",
          "title": "Output",
          "type": "string"
        }
      },
      "required": [
        "parser",
        "output"
      ],
      "title": "Tool",
      "type": "object"
    },
    "Tools": {
      "additionalProperties": false,
      "description": "Fixed tool configuration set for Library Tools commands.",
      "properties": {
        "lint": {
          "$ref": "#/$defs/Tool",
          "description": "Lint command configuration."
        },
        "scan": {
          "$ref": "#/$defs/Tool",
          "description": "Scan command configuration."
        },
        "refurbish": {
          "$ref": "#/$defs/Tool",
          "description": "Refurbish command configuration."
        },
        "curate": {
          "$ref": "#/$defs/Tool",
          "description": "Curate command configuration."
        },
        "provenance": {
          "$ref": "#/$defs/Tool",
          "description": "Provenance command configuration."
        },
        "push": {
          "$ref": "#/$defs/Tool",
          "description": "Push command configuration."
        }
      },
      "title": "Tools",
      "type": "object"
    }
  },
  "$id": "https://raw.githubusercontent.com/opencadc/canfar-library/main/.spec.json",
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "additionalProperties": false,
  "description": "Schema to capture build intent, discovery metadata, and tool configuration.",
  "properties": {
    "schemaVersion": {
      "const": 1,
      "description": "Library manifest schema version.",
      "title": "Schemaversion",
      "type": "integer"
    },
    "registry": {
      "$ref": "#/$defs/Registry",
      "description": "Image registry."
    },
    "maintainers": {
      "description": "Image maintainers.",
      "items": {
        "$ref": "#/$defs/Maintainer"
      },
      "title": "Maintainers",
      "type": "array"
    },
    "git": {
      "$ref": "#/$defs/Git",
      "description": "Image repository.",
      "title": "Git Info"
    },
    "build": {
      "$ref": "#/$defs/Build",
      "description": "Image build info.",
      "title": "Build Info"
    },
    "metadata": {
      "$ref": "#/$defs/Metadata",
      "description": "Image metadata."
    },
    "config": {
      "$ref": "#/$defs/Config",
      "description": "Tool configuration."
    }
  },
  "required": [
    "schemaVersion",
    "registry",
    "maintainers",
    "git",
    "build",
    "metadata",
    "config"
  ],
  "title": "CANFAR Library Tools Schema",
  "type": "object"
}
