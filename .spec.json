{
  "$defs": {
    "Build": {
      "additionalProperties": false,
      "description": "Build information.",
      "properties": {
        "path": {
          "default": ".",
          "description": "Path to the directory containing the Dockerfile; defaults to the root of the repository.",
          "title": "Path",
          "type": "string"
        },
        "dockerfile": {
          "default": "Dockerfile",
          "description": "Name of the Dockerfile relative to the path.",
          "examples": [
            "Dockerfile",
            "Dockerfile-alternate"
          ],
          "title": "Dockerfile",
          "type": "string"
        },
        "context": {
          "default": ".",
          "description": "Build context path relative to the Dockerfile.",
          "examples": [
            ".",
            "../"
          ],
          "title": "Build Context",
          "type": "string"
        },
        "builder": {
          "default": "buildkit",
          "description": "Builder backend used for this entry.",
          "examples": [
            "buildkit"
          ],
          "title": "Build Backend",
          "type": "string"
        },
        "platforms": {
          "default": [
            "linux/amd64"
          ],
          "description": "Set target platforms for build.",
          "examples": [
            [
              "linux/amd64"
            ],
            [
              "linux/amd64",
              "linux/arm64"
            ]
          ],
          "items": {
            "enum": [
              "linux/amd64",
              "linux/arm64",
              "linux/arm/v7",
              "linux/arm/v6",
              "linux/arm/v5",
              "windows/amd64"
            ],
            "type": "string"
          },
          "title": "Target Platforms",
          "type": "array"
        },
        "tags": {
          "description": "Tags produced by this build entry.",
          "examples": [
            "latest",
            "1.0.0"
          ],
          "items": {
            "type": "string"
          },
          "title": "Container Image Tags",
          "type": "array"
        },
        "args": {
          "anyOf": [
            {
              "additionalProperties": {
                "type": "string"
              },
              "type": "object"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "Set build-time variables for the build.",
          "examples": [
            {
              "FOO": "bar"
            }
          ],
          "title": "Build Args"
        },
        "annotations": {
          "anyOf": [
            {
              "additionalProperties": {
                "type": "string"
              },
              "type": "object"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "Add annotation to the container image.",
          "examples": [
            {
              "canfar.image.type": "base"
            }
          ],
          "title": "Image Annotations"
        },
        "labels": {
          "anyOf": [
            {
              "additionalProperties": {
                "type": "string"
              },
              "type": "object"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "Add metadata to the container image.",
          "examples": [
            {
              "org.opencontainers.image.description": "Base image for CANFAR Science Platform",
              "org.opencontainers.image.title": "CANFAR Base Image"
            }
          ],
          "title": "Image Labels"
        },
        "target": {
          "anyOf": [
            {
              "type": "string"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "Set the target build stage to build.",
          "examples": [
            "runtime"
          ],
          "title": "Build Target"
        },
        "test": {
          "anyOf": [
            {
              "$ref": "#/$defs/Run"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "Command to run in the created container to verify the image is working.",
          "title": "Image Test Command"
        }
      },
      "required": [
        "tags"
      ],
      "title": "Build",
      "type": "object"
    },
    "Git": {
      "additionalProperties": false,
      "description": "Git repository which contains build source.",
      "properties": {
        "repo": {
          "description": "Git repository which contains the build source.",
          "format": "uri",
          "minLength": 1,
          "title": "Repository",
          "type": "string"
        },
        "tag": {
          "description": "Tag reference to checkout for build.",
          "examples": [
            "refs/tags/v1.0.0",
            "v1.0.0"
          ],
          "title": "Git Tag Reference",
          "type": "string"
        },
        "sha": {
          "anyOf": [
            {
              "type": "string"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "Optional commit SHA for the Git Tag Reference.If provided, the build will fail if the SHA does not match the tag reference.If not provided, the SHA is looked up from the tag reference.",
          "title": "Commit SHA for the Git Tag Reference"
        }
      },
      "required": [
        "repo",
        "tag"
      ],
      "title": "Git",
      "type": "object"
    },
    "Maintainer": {
      "additionalProperties": false,
      "description": "Build Maintainer Information.",
      "properties": {
        "name": {
          "description": "Full name of the maintainer.",
          "title": "Name",
          "type": "string"
        },
        "email": {
          "description": "Contact email, required for traceability.",
          "title": "Email",
          "type": "string"
        },
        "github": {
          "anyOf": [
            {
              "type": "string"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "Optional Github Username.",
          "title": "Maintainer Github"
        },
        "gitlab": {
          "anyOf": [
            {
              "type": "string"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "Optional Gitlab Username.",
          "title": "Maintainer Gitlab"
        }
      },
      "required": [
        "name",
        "email"
      ],
      "title": "Maintainer",
      "type": "object"
    },
    "Metadata": {
      "description": "Metadata for the image.",
      "properties": {
        "identifier": {
          "description": "Unique science identifier for the image.",
          "title": "Identifier",
          "type": "string"
        },
        "project": {
          "description": "SRCnet Project name for the image.",
          "title": "Project",
          "type": "string"
        }
      },
      "required": [
        "identifier",
        "project"
      ],
      "title": "Metadata",
      "type": "object"
    },
    "Run": {
      "description": "Test information for the image.",
      "properties": {
        "cmd": {
          "anyOf": [
            {
              "type": "string"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "Command to run in the created container to verify the image is working. The command is run with `docker run --rm -it <image> <cmd>`, where image is populated automatically from the build process. If the command returns a non-zero exit code, the test is considered to have failed.",
          "examples": [
            "bash -c 'echo hello world'"
          ],
          "title": "Testing Command"
        }
      },
      "title": "Run",
      "type": "object"
    }
  },
  "$id": "https://raw.githubusercontent.com/opencadc/canfar-library/main/.spec.json",
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "additionalProperties": false,
  "description": "Single, reviewable schema to capture ownership, build source, build intent, and downstream identity for library artifacts.",
  "properties": {
    "name": {
      "description": "Name of the image.",
      "examples": [
        "astroml"
      ],
      "title": "Name",
      "type": "string"
    },
    "maintainers": {
      "description": "List of maintainers responsible for the image.",
      "items": {
        "$ref": "#/$defs/Maintainer"
      },
      "title": "Maintainers",
      "type": "array"
    },
    "git": {
      "$ref": "#/$defs/Git",
      "description": "Repository information for the image.",
      "title": "Git Info"
    },
    "build": {
      "$ref": "#/$defs/Build",
      "description": "Build information for the image.",
      "title": "Build Info"
    },
    "metadata": {
      "$ref": "#/$defs/Metadata"
    }
  },
  "required": [
    "name",
    "maintainers",
    "git",
    "build",
    "metadata"
  ],
  "title": "CANFAR Library Manifest",
  "type": "object"
}
