{
  "$defs": {
    "Author": {
      "additionalProperties": false,
      "description": "Details about an author of the image.",
      "properties": {
        "name": {
          "description": "Name of the author.",
          "examples": [
            "John Doe"
          ],
          "title": "Name",
          "type": "string"
        },
        "email": {
          "description": "Contact email address for the author.",
          "examples": [
            "john.doe@example.com"
          ],
          "title": "Email",
          "type": "string"
        },
        "github": {
          "anyOf": [
            {
              "type": "string"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "GitHub Username.",
          "examples": [
            "johndoe"
          ],
          "title": "GitHub Username"
        },
        "gitlab": {
          "anyOf": [
            {
              "type": "string"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "GitLab Username.",
          "examples": [
            "johndoe"
          ],
          "title": "GitLab Username"
        },
        "orcid": {
          "anyOf": [
            {
              "type": "string"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "Open Researcher and Contributor ID.",
          "examples": [
            "0000-0002-1825-0097"
          ],
          "title": "ORCID"
        },
        "affiliation": {
          "anyOf": [
            {
              "type": "string"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "Affiliation of the author.",
          "examples": [
            "Oxford University"
          ],
          "title": "Affiliation"
        },
        "role": {
          "default": "maintainer",
          "description": "Role of the author.",
          "examples": [
            "maintainer",
            "contributor",
            "researcher",
            "developer"
          ],
          "title": "Role",
          "type": "string"
        }
      },
      "required": [
        "name",
        "email"
      ],
      "title": "Author",
      "type": "object"
    },
    "Build": {
      "additionalProperties": false,
      "description": "Configuration for building the container image.",
      "properties": {
        "context": {
          "default": ".",
          "description": "Path to the build context directory.",
          "examples": [
            ".",
            "images/python"
          ],
          "title": "Build Context",
          "type": "string"
        },
        "file": {
          "default": "Dockerfile",
          "description": "Name of the Dockerfile in the build context.",
          "examples": [
            "Dockerfile",
            "Dockerfile.runtime"
          ],
          "title": "Dockerfile",
          "type": "string"
        },
        "platforms": {
          "default": [
            "linux/amd64"
          ],
          "description": "Target platforms for the build.",
          "examples": [
            [
              "linux/amd64"
            ],
            [
              "linux/amd64",
              "linux/arm64"
            ]
          ],
          "items": {
            "type": "string"
          },
          "title": "Platforms",
          "type": "array"
        },
        "tags": {
          "description": "Image tags to apply.",
          "examples": [
            [
              "latest"
            ],
            [
              "1.0.0",
              "latest"
            ]
          ],
          "items": {
            "type": "string"
          },
          "minItems": 1,
          "title": "Tags",
          "type": "array"
        },
        "output": {
          "default": "type=docker",
          "description": "Output destination (type=docker by default).",
          "examples": [
            "type=docker",
            "type=registry",
            "type=local,dest=./out"
          ],
          "title": "Output",
          "type": "string"
        },
        "options": {
          "default": "",
          "description": "Additional buildx options appended to the build command.",
          "examples": [
            "--target=runtime --push"
          ],
          "title": "Options",
          "type": "string"
        }
      },
      "required": [
        "tags"
      ],
      "title": "Build",
      "type": "object"
    },
    "Config": {
      "additionalProperties": false,
      "description": "Configuration for Library Tools execution and CLI wiring.",
      "properties": {
        "policy": {
          "default": "default",
          "description": "Policy profile for tooling behavior.",
          "enum": [
            "default",
            "strict",
            "expert"
          ],
          "title": "Policy",
          "type": "string"
        },
        "conflicts": {
          "default": "warn",
          "description": "Conflict handling mode for tooling behavior.",
          "enum": [
            "warn",
            "strict"
          ],
          "title": "Conflicts",
          "type": "string"
        },
        "tools": {
          "description": "Tool definitions available to CLI steps.",
          "items": {
            "$ref": "#/$defs/Tool"
          },
          "title": "Tools",
          "type": "array"
        },
        "cli": {
          "additionalProperties": {
            "type": "string"
          },
          "description": "CLI step name to tool id mapping.",
          "examples": [
            {
              "lint": "default-linter",
              "scan": "default-scanner"
            }
          ],
          "title": "Cli",
          "type": "object"
        }
      },
      "title": "Config",
      "type": "object"
    },
    "Discovery": {
      "additionalProperties": false,
      "description": "Discovery metadata mapped to OCI labels/annotations.",
      "properties": {
        "title": {
          "description": "Human-readable title of the image.",
          "examples": [
            "Baseband Analysis"
          ],
          "title": "Title",
          "type": "string"
        },
        "description": {
          "description": "Human-readable description of the software packaged in the image.",
          "examples": [
            "Baseband analysis tools for radio astronomy."
          ],
          "maxLength": 255,
          "minLength": 1,
          "title": "Description",
          "type": "string"
        },
        "source": {
          "description": "URL to get source code for building the image.",
          "examples": [
            "https://github.com/example/repo"
          ],
          "format": "uri",
          "minLength": 1,
          "title": "Source",
          "type": "string"
        },
        "url": {
          "anyOf": [
            {
              "format": "uri",
              "minLength": 1,
              "type": "string"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "URL to find more information on the image.",
          "examples": [
            "https://example.com/baseband-analysis"
          ],
          "title": "URL"
        },
        "documentation": {
          "anyOf": [
            {
              "format": "uri",
              "minLength": 1,
              "type": "string"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "URL to get documentation on the image.",
          "examples": [
            "https://example.com/baseband-analysis/docs"
          ],
          "title": "Documentation"
        },
        "version": {
          "description": "Version of the packaged software.",
          "examples": [
            "1.0.0"
          ],
          "title": "Version",
          "type": "string"
        },
        "revision": {
          "default": "unknown",
          "description": "Source control revision identifier for the packaged software.",
          "examples": [
            "1234567890123456789012345678901234567890"
          ],
          "title": "Revision",
          "type": "string"
        },
        "created": {
          "default": "2026-02-20T16:18:51.616195-08:00",
          "description": "Datetime on which the image was built. Conforming to RFC 3339.",
          "examples": [
            "2026-02-05T12:00:00Z"
          ],
          "format": "date-time",
          "title": "Created Timestamp",
          "type": "string"
        },
        "authors": {
          "description": "Details of the people or organization responsible for the image",
          "examples": [
            {
              "email": "john.doe@example.com",
              "name": "John Doe"
            }
          ],
          "items": {
            "$ref": "#/$defs/Author"
          },
          "title": "Authors",
          "type": "array"
        },
        "licenses": {
          "description": "License(s) under which contained software is distributed as an SPDX License Expression.",
          "examples": [
            "AGPL-3.0",
            "AGPL-3.0-only",
            ""
          ],
          "title": "Licenses",
          "type": "string"
        },
        "keywords": {
          "description": "Keywords used to support software discovery and search.",
          "examples": [
            "astronomy",
            "analysis",
            "python"
          ],
          "items": {
            "type": "string"
          },
          "title": "Keywords",
          "type": "array"
        },
        "domain": {
          "default": [
            "astronomy"
          ],
          "description": "Scientific domains supported by this image.",
          "examples": [
            [
              "astronomy"
            ],
            [
              "astronomy",
              "scientific-computing"
            ]
          ],
          "items": {
            "type": "string"
          },
          "minItems": 1,
          "title": "Domain",
          "type": "array"
        },
        "kind": {
          "description": "Discovery kinds that classify this image.",
          "examples": [
            [
              "headless"
            ],
            [
              "notebook",
              "headless"
            ]
          ],
          "items": {
            "enum": [
              "notebook",
              "headless",
              "carta",
              "firefly",
              "contributed",
              "desktop"
            ],
            "type": "string"
          },
          "minItems": 1,
          "title": "Kind",
          "type": "array"
        },
        "tools": {
          "description": "Common tools included in the image.",
          "examples": [
            "python",
            "jupyterlab",
            "astropy"
          ],
          "items": {
            "type": "string"
          },
          "title": "Tools",
          "type": "array"
        },
        "deprecated": {
          "default": false,
          "description": "Whether this image is deprecated and should no longer be used.",
          "examples": [
            false,
            true
          ],
          "title": "Deprecated",
          "type": "boolean"
        }
      },
      "required": [
        "title",
        "description",
        "source",
        "version",
        "authors",
        "licenses",
        "keywords",
        "kind"
      ],
      "title": "Discovery",
      "type": "object"
    },
    "Metadata": {
      "additionalProperties": false,
      "description": "Metadata for the image.",
      "properties": {
        "discovery": {
          "$ref": "#/$defs/Discovery",
          "description": "Canonical discovery metadata."
        }
      },
      "required": [
        "discovery"
      ],
      "title": "Metadata",
      "type": "object"
    },
    "Registry": {
      "additionalProperties": false,
      "description": "Details about the container registry.",
      "properties": {
        "host": {
          "description": "Container registry hostname.",
          "examples": [
            "images.canfar.net",
            "docker.io"
          ],
          "title": "Hostname",
          "type": "string"
        },
        "project": {
          "description": "Container registry project/namespace.",
          "examples": [
            "skaha",
            "chimefrb"
          ],
          "title": "Project",
          "type": "string"
        },
        "image": {
          "description": "Container image name.",
          "examples": [
            "python",
            "baseband-analysis"
          ],
          "title": "Image Name",
          "type": "string"
        }
      },
      "required": [
        "host",
        "project",
        "image"
      ],
      "title": "Registry",
      "type": "object"
    },
    "Tool": {
      "additionalProperties": false,
      "description": "Definition of a Library Tool.",
      "properties": {
        "id": {
          "description": "Unique tool identifier.",
          "examples": [
            "default-scanner",
            "srcnet-scanner"
          ],
          "pattern": "^[a-zA-Z0-9][a-zA-Z0-9._-]*$",
          "title": "Tool ID",
          "type": "string"
        },
        "parser": {
          "description": "Built-in parser used to consume the tool outputs.",
          "enum": [
            "hadolint",
            "trivy",
            "renovate",
            "curate",
            "provenance",
            "push"
          ],
          "examples": [
            "trivy",
            "hadolint"
          ],
          "title": "Parser",
          "type": "string"
        },
        "image": {
          "description": "Container image used to run the tool.",
          "examples": [
            "docker.io/aquasec/trivy:latest"
          ],
          "title": "Tool Image",
          "type": "string"
        },
        "command": {
          "description": "Tokenized command executed in the tool container.Supported tokens: {{inputs.<key>}} and {{image.reference}}.",
          "examples": [
            [
              "trivy",
              "image",
              "--config",
              "{{inputs.trivy}}",
              "--format",
              "json",
              "--output",
              "/outputs/report.json",
              "{{image.reference}}"
            ]
          ],
          "items": {
            "type": "string"
          },
          "minItems": 1,
          "title": "Command",
          "type": "array"
        },
        "env": {
          "additionalProperties": {
            "type": "string"
          },
          "description": "Environment variables passed to the tool container.",
          "examples": [
            {
              "TRIVY_DEBUG": "true"
            }
          ],
          "title": "Tool Environment",
          "type": "object"
        },
        "inputs": {
          "additionalProperties": {
            "$ref": "#/$defs/ToolInputs"
          },
          "description": "Tool inputs mounted into the tool container.",
          "title": "Inputs",
          "type": "object"
        },
        "socket": {
          "default": false,
          "description": "Whether /var/run/docker.sock is mounted into the tool container.",
          "title": "Docker Socket",
          "type": "boolean"
        },
        "outputs": {
          "const": "/outputs/",
          "default": "/outputs/",
          "description": "Fixed container directory where tools must write outputs.",
          "examples": [
            "/outputs/"
          ],
          "title": "Tool Outputs Path",
          "type": "string"
        }
      },
      "required": [
        "id",
        "parser",
        "image",
        "command"
      ],
      "title": "Tool",
      "type": "object"
    },
    "ToolInputs": {
      "additionalProperties": false,
      "description": "Named tool inputs resolved by CLI into deterministic mounts.",
      "properties": {
        "source": {
          "anyOf": [
            {
              "const": "default",
              "type": "string"
            },
            {
              "format": "file-path",
              "type": "string"
            }
          ],
          "default": "default",
          "description": "Input source for the tool. 'default' maps to built-in config shipped with the library; otherwise provide a local file path.",
          "examples": [
            "default",
            "./ci/.trivy.yaml"
          ],
          "title": "Source"
        },
        "destination": {
          "default": "/config.yaml",
          "description": "Absolute path in the tool container where the input is mounted.",
          "examples": [
            "/config.yaml",
            "/workspace/config/trivy.yaml"
          ],
          "title": "Destination",
          "type": "string"
        }
      },
      "title": "ToolInputs",
      "type": "object"
    }
  },
  "$id": "https://raw.githubusercontent.com/opencadc/canfar-library/main/.spec.json",
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "additionalProperties": false,
  "description": "Canonical schema for build intent, discovery metadata, and tool configuration. Runtime defaults and layered override merging are applied separately before validation.",
  "properties": {
    "version": {
      "const": 1,
      "default": 1,
      "description": "Library manifest schema version.",
      "title": "Version",
      "type": "integer"
    },
    "registry": {
      "$ref": "#/$defs/Registry",
      "description": "Image registry."
    },
    "build": {
      "$ref": "#/$defs/Build",
      "description": "Image build info.",
      "title": "Build Info"
    },
    "metadata": {
      "$ref": "#/$defs/Metadata",
      "description": "Image metadata."
    },
    "config": {
      "$ref": "#/$defs/Config",
      "description": "Tool configuration."
    }
  },
  "required": [
    "registry",
    "build",
    "metadata",
    "config"
  ],
  "title": "CANFAR Library Tools Schema",
  "type": "object"
}
